From 107b83786f751901f212f9c17082758025a3b3df Mon Sep 17 00:00:00 2001
From: shucheng <shucheng@bd-apaas.com>
Date: Thu, 14 Dec 2023 17:08:43 +0800
Subject: [PATCH] v2.8.3-support-anonymous-pull-image

---
 registry/auth/htpasswd/access.go | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/registry/auth/htpasswd/access.go b/registry/auth/htpasswd/access.go
index 2611a23b..9d73eef1 100644
--- a/registry/auth/htpasswd/access.go
+++ b/registry/auth/htpasswd/access.go
@@ -57,6 +57,10 @@ func (ac *accessController) Authorized(ctx context.Context, accessRecords ...aut
 
 	username, password, ok := req.BasicAuth()
 	if !ok {
+		if req.Method != "POST" && os.Getenv("BEAGLE_AUTH_ANONYMOUS") == "PUBLIC" {
+			return auth.WithUser(ctx, auth.UserInfo{Name: "anonymous"}), nil
+		}
+
 		return nil, &challenge{
 			realm: ac.realm,
 			err:   auth.ErrInvalidCredential,
-- 
2.39.2

